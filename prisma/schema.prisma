generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  TEACHER
  PARENT
}

enum Shift {
  MORNING
  AFTERNOON
  EVENING
  FULLTIME
}

enum Segment {
  INFANTIL
  FUNDAMENTAL_I
  FUNDAMENTAL_II
  MEDIO
}

// ==========================================
// USUÁRIOS E AUTENTICAÇÃO
// ==========================================

model User {
  id       String @id @default(cuid())
  name     String
  email    String @unique
  password String
  role     Role   @default(PARENT)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relação: Aulas que este professor leciona (Grade Curricular)
  teachingAssignments ClassSubject[]
}

// ==========================================
// ESTRUTURA ACADÊMICA
// ==========================================

model Class {
  id      String  @id @default(cuid())
  name    String  // Ex: 1º Ano A
  grade   String  // Ex: 1º Ano
  year    Int
  shift   Shift
  segment Segment

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  students Enrollment[]   // Alunos matriculados
  subjects ClassSubject[] // Grade curricular (Matérias desta turma)
  grades   Grade[]        // Notas lançadas nesta turma
}

model Subject {
  id        String   @id @default(cuid())
  name      String   // Ex: Matemática
  code      String?  // Ex: MAT-101
  createdAt DateTime @default(now())

  // Relações
  classSubjects ClassSubject[] // Em quais turmas essa matéria existe
  grades        Grade[]        // Notas vinculadas a essa matéria geral
}

// 
// "Na Turma X, a matéria Y é dada pelo Professor Z"
model ClassSubject {
  id String @id @default(cuid())

  classId String
  class   Class  @relation(fields: [classId], references: [id], onDelete: Cascade)

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id])

  teacherId String? // Pode ser null se a turma estiver sem prof. dessa matéria
  teacher   User?   @relation(fields: [teacherId], references: [id])

  // Garante que não tenha duas "Matemática" na mesma turma
  @@unique([classId, subjectId])
}

// ==========================================
//  ALUNOS E MATRÍCULAS
// ==========================================

model Student {
  id            String    @id @default(cuid())
  name          String
  email         String?
  birthDate     DateTime?
  guardianName  String?
  guardianPhone String?
  guardianEmail String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  enrollments Enrollment[]
  grades      Grade[]
}

model Enrollment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  studentId String
  student   Student @relation(fields: [studentId], references: [id])
  
  classId   String
  class     Class   @relation(fields: [classId], references: [id])

  // Um aluno só pode estar matriculado uma vez na mesma turma
  @@unique([studentId, classId])
}

// ==========================================
//  NOTAS E AVALIAÇÕES
// ==========================================

model Grade {
  id            String   @id @default(cuid())
  
  // Notas Parciais
  testGrade     Float?   @default(0) // Provas
  workGrade     Float?   @default(0) // Trabalhos
  behaviorGrade Float?   @default(0) // Participação/Comportamento
  
  // Média Final (Calculada)
  value         Float    

  term          Int      // 1º Bimestre, 2º Bimestre...
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Conexões
  studentId String
  student   Student @relation(fields: [studentId], references: [id])
  
  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id])
  
  classId   String
  class     Class   @relation(fields: [classId], references: [id])
}

// ==========================================
// 5. SISTEMA GERAL
// ==========================================

model Announcement {
  id        String   @id @default(cuid())
  title     String
  content   String   @db.Text
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SchoolSettings {
  id              String   @id @default(cuid())
  schoolName      String   @default("Minha Escola")
  schoolLogo      String?
  cnpj            String?
  address         String?
  phone           String?
  
  currentYear     String   @default("2025")
  passingGrade    Float    @default(6.0)
  periodicity     String   @default("BIMESTRAL")
  minFrequency    Float    @default(75.0)
  
  isGradesVisible Boolean  @default(false)
  isMaintenance   Boolean  @default(false)
  
  updatedAt       DateTime @updatedAt
}